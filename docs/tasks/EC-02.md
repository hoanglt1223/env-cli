# EC-02: Core Environment Management Implementation

## Task Description

Implement the core functionality for environment variable management, including project initialization, environment switching, and configuration management. This task provides the foundational features that make env-cli a powerful tool for managing environment variables across development workflows.

## Requirements

### Project Structure Management
- Initialize project with `.env/` directory structure
- Create configuration management system (`.env/config.toml`)
- Support multiple named environments (development, staging, production)
- Handle environment file templates and inheritance

### Environment Switching
- Safe switching between environments with validation
- Backup current environment before switching
- Support for environment inheritance and overrides
- Rollback capability if switch fails

### Configuration System
- TOML-based configuration files
- Environment-specific settings
- Validation rules and security policies
- Project metadata and default environment

### Error Handling & UX
- User-friendly error messages with context
- Confirmation prompts for destructive operations
- Progress indicators for long-running operations
- Proper validation and feedback

## Implementation Details

### Prerequisites
- EC-01 must be completed
- Understanding of environment variable management best practices
- TOML configuration file format knowledge

### Core Components

#### 1. Configuration Management (`src/config/mod.rs`)
```rust
pub struct Config {
    pub project: ProjectConfig,
    pub environments: Vec<EnvironmentConfig>,
    pub scan: ScanConfig,
    pub validation: ValidationConfig,
}

pub struct EnvironmentConfig {
    pub name: String,
    pub description: String,
    pub file: PathBuf,
    pub inherits_from: Option<String>,
}
```

#### 2. Environment Management (`src/env/mod.rs`)
- Environment variable parsing and validation
- File I/O operations for `.env` files
- Environment switching logic with validation
- Backup and restore functionality

#### 3. Command Implementations
- **init.rs**: Complete project initialization
- **switch.rs**: Environment switching with safety checks
- **validate.rs**: Configuration validation
- **status.rs**: Current environment status reporting

### Implementation Steps

#### Phase 1: Configuration System
1. **Create config structures**:
   - Define `Config`, `ProjectConfig`, `EnvironmentConfig` structs
   - Implement TOML serialization/deserialization
   - Add configuration validation logic

2. **Initialize command implementation**:
   - Create `.env/` directory structure
   - Generate default configuration file
   - Set up environment templates
   - Handle force re-initialization

#### Phase 2: Environment Management
3. **Environment variable utilities**:
   - Parse `.env` file format with comments
   - Validate environment variable names/values
   - Handle variable expansion and substitution
   - Implement secure secret handling

4. **Switch command implementation**:
   - Validate target environment exists
   - Create backup of current environment
   - Load and validate new environment
   - Update project state and symlinks

#### Phase 3: Validation & Status
5. **Validate command implementation**:
   - Check required environment variables
   - Validate variable formats and constraints
   - Detect unused variables
   - Security policy validation

6. **Status command implementation**:
   - Display current environment state
   - Show environment history and changes
   - List available environments
   - Verbose mode with detailed information

### File Structure After Implementation
```
.env/
├── config.toml              # Main configuration
├── environments/
│   ├── development.env      # Development environment
│   ├── staging.env         # Staging environment
│   ├── production.env      # Production environment
│   └── .template           # Environment template
├── backups/                # Environment backups
└── .current                # Current environment symlink
```

## Status

### Phase 1: Configuration System
- [ ] Create config module structure
- [ ] Define configuration data structures
- [ ] Implement TOML serialization
- [ ] Add configuration validation
- [ ] Create default configuration templates

### Phase 2: Environment Management
- [ ] Implement environment variable parsing
- [ ] Create file I/O utilities
- [ ] Build environment switching logic
- [ ] Add backup and restore functionality
- [ ] Implement secure handling of secrets

### Phase 3: Command Implementation
- [ ] Complete `init` command implementation
- [ ] Complete `switch` command implementation
- [ ] Complete `validate` command implementation
- [ ] Complete `status` command implementation
- [ ] Add comprehensive error handling

### Testing & Integration
- [ ] Unit tests for all components
- [ ] Integration tests for command workflows
- [ ] Error case testing and validation
- [ ] Performance testing with large environments

## Completion Criteria

### Functional Requirements
- [ ] `env init` creates complete project structure
- [ ] `env switch <env>` safely switches between environments
- [ ] `env validate` checks configuration correctness
- [ ] `env status` shows current environment state
- [ ] Configuration system supports complex project setups
- [ ] All operations handle edge cases gracefully

### Quality Requirements
- [ ] 95%+ code coverage for implemented features
- [ ] All error cases have user-friendly messages
- [ ] Performance suitable for large codebases
- [ ] Security best practices followed
- [ ] Comprehensive documentation for all features

### Integration Requirements
- [ ] Commands integrate with existing CLI framework
- [ ] Configuration system works with planned future features
- [ ] Error handling consistent across all commands
- [ ] User experience follows CLI design principles

## Dependencies

- EC-01: Init source code with latest stable rust (✅ Completed)
- Cargo dependencies: `toml`, `serde`, `anyhow`, `clap` (already configured)

## Technical Specifications

### Configuration File Format (`.env/config.toml`)
```toml
[project]
name = "my-project"
default_environment = "development"

[[environments]]
name = "development"
description = "Development environment"
file = ".env/environments/development.env"

[[environments]]
name = "staging"
description = "Staging environment"
file = ".env/environments/staging.env"

[validation]
required = ["DATABASE_URL", "API_KEY"]

[validation.security]
sensitive_patterns = [".*KEY.*", ".*SECRET.*"]
min_secret_length = 16
```

### Environment File Format
```bash
# Database configuration
DATABASE_URL=postgresql://localhost/myapp
DATABASE_POOL_SIZE=10

# API configuration
API_KEY=your-api-key-here
API_ENDPOINT=https://api.example.com

# Feature flags
FEATURE_NEW_UI=true
DEBUG_MODE=false
```

## Security Considerations

- Secure handling of sensitive environment variables
- Proper file permissions for environment files
- Validation of user input to prevent injection
- Backup security and cleanup procedures
- Audit logging for environment switches

## Notes

This is the core implementation task that provides the fundamental functionality. All subsequent features will build upon this foundation. The focus is on reliability, security, and user experience for the most common environment management workflows.

**Key Success Metrics**: Users should be able to initialize a project, switch between environments safely, and validate their configurations with confidence that their data is secure and operations are reliable.